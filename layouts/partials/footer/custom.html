<!-- èƒŒæ™¯å›¾ç‰‡ -->
{{ partial "footer/background-image.html" . }}

<!-- ä¸‰ä¸ªæ¿å—æ ·å¼ -->
{{ partial "footer/section-styles.html" . }}

<!-- å­—ä½“é¢œè‰²ä¼˜åŒ– -->
{{ partial "footer/font-colors.html" . }}

<!-- éŸ³ä¹æ’­æ”¾å™¨ï¼ˆç§»åˆ°å¯æ‰©å±•æ§åˆ¶æŒ‰é’®å®¹å™¨å¤–éƒ¨ï¼‰ -->
{{ partial "footer/music-player.html" . }}

<!-- å¯æ‰©å±•æ§åˆ¶æŒ‰é’®å®¹å™¨ -->
<div class="expandable-controls-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 99999; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
  <div class="controls-wrapper" style="display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, rgba(255, 200, 210, 0.8), rgba(170, 210, 230, 0.8)); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50px; padding: 8px; box-shadow: 0 4px 16px rgba(170, 210, 230, 0.4); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); width: 50px; height: 50px; overflow: hidden; flex-direction: row-reverse;">
    <!-- å±•å¼€/æ”¶èµ·ç®­å¤´ -->
    <button id="expand-toggle" class="expand-toggle" aria-label="å±•å¼€/æ”¶èµ·æ§åˆ¶æŒ‰é’®" title="å±•å¼€/æ”¶èµ·æ§åˆ¶æŒ‰é’®" style="width: 34px; height: 34px; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #333; transition: all 0.3s ease; flex-shrink: 0;">
      <span class="expand-arrow" style="display: block; transition: transform 0.3s ease;">â˜°</span>
    </button>
    
    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="control-buttons" style="display: flex; gap: 16px; transition: all 0.3s ease; transform: translateX(-20px); opacity: 0; pointer-events: none;">
      <!-- éŸ³ä¹æ’­æ”¾å™¨æ§åˆ¶æŒ‰é’® -->
      <button id="music-player-toggle" class="music-player-toggle control-button" aria-label="éŸ³ä¹æ’­æ”¾å™¨" title="éŸ³ä¹æ’­æ”¾å™¨" style="width: 34px; height: 34px; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #333; transition: all 0.3s ease;">
        <span class="toggle-icon play-icon" style="display: block; transition: all 0.3s ease;">â™ª</span>
        <span class="toggle-icon close-icon" style="display: none; transition: all 0.3s ease; font-size: 16px; font-weight: bold;">Ã—</span>
      </button>
      
      <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
      {{ partial "footer/theme-toggle.html" . }}
      
      <!-- éšè—åº¦è°ƒèŠ‚æŒ‰é’® -->
      <button id="transparency-toggle" class="transparency-toggle control-button" aria-label="éšè—åº¦è°ƒèŠ‚" title="éšè—åº¦è°ƒèŠ‚" style="width: 34px; height: 34px; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #333; transition: all 0.3s ease;">
        <span class="transparency-icon" style="display: block; transition: all 0.3s ease;">ğŸ‘</span>
      </button>
      
      <!-- æ²‰æµ¸é˜…è¯»æŒ‰é’® -->
      <button id="immersive-reading-button" class="immersive-reading-button control-button" aria-label="æ²‰æµ¸é˜…è¯»" title="æ²‰æµ¸é˜…è¯»" style="width: 34px; height: 34px; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #333; transition: all 0.3s ease;">
        <span class="immersive-icon book-icon" style="display: block; transition: all 0.3s ease;">ğŸ“–</span>
        <span class="immersive-icon exit-icon" style="display: none; transition: all 0.3s ease;">Ã—</span>
      </button>
    </div>
    
    <!-- éšè—åº¦è°ƒèŠ‚é¢æ¿ -->
    <div id="transparency-panel" class="transparency-panel" style="position: absolute; bottom: 70px; right: 0; width: 200px; background: linear-gradient(135deg, rgba(255, 200, 210, 0.9), rgba(170, 210, 230, 0.9)); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 16px; box-shadow: 0 8px 32px rgba(170, 210, 230, 0.4); z-index: 99999; transform: translateX(100%); opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
      <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #333; text-align: center;">éšè—åº¦è°ƒèŠ‚</h4>
      <div class="transparency-slider-container" style="display: flex; flex-direction: column; gap: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 12px; color: #333;">å®Œå…¨éšè—</span>
          <span style="font-size: 12px; color: #333;">å®Œå…¨æ˜¾ç¤º</span>
        </div>
        <input type="range" id="transparency-slider" class="transparency-slider" min="0" max="100" value="100" style="width: 100%; height: 8px; border-radius: 4px; background: rgba(255, 255, 255, 0.5); outline: none; -webkit-appearance: none; appearance: none; transition: all 0.3s ease;">
        <div style="text-align: center;">
          <span id="transparency-value" style="font-size: 12px; color: #333; font-weight: 600;">100%</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å±•å¼€/æ”¶èµ·æ§åˆ¶è„šæœ¬ -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const expandToggle = document.getElementById('expand-toggle');
    const controlButtons = document.querySelector('.control-buttons');
    const expandArrow = document.querySelector('.expand-arrow');
    const controlsWrapper = document.querySelector('.controls-wrapper');
    
    let isExpanded = false;
    
    expandToggle.addEventListener('click', function() {
      isExpanded = !isExpanded;
      
      if (isExpanded) {
        // å±•å¼€çŠ¶æ€
        expandArrow.textContent = 'âœ•';
        controlsWrapper.style.width = 'auto';
        controlsWrapper.style.minWidth = '180px';
        controlsWrapper.style.borderRadius = '25px';
        controlButtons.style.transform = 'translateX(0)';
        controlButtons.style.opacity = '1';
        controlButtons.style.pointerEvents = 'auto';
      } else {
        // æ”¶èµ·çŠ¶æ€
        expandArrow.textContent = 'â˜°';
        controlsWrapper.style.width = '50px';
        controlsWrapper.style.minWidth = '50px';
        controlsWrapper.style.borderRadius = '50px';
        controlButtons.style.transform = 'translateX(-20px)';
        controlButtons.style.opacity = '0';
        controlButtons.style.pointerEvents = 'none';
      }
  });

  // åˆå§‹çŠ¶æ€ï¼šæ”¶èµ·ï¼ˆåœ†å½¢ï¼‰
  isExpanded = false;
  expandArrow.textContent = 'â˜°';
  controlsWrapper.style.width = '50px';
  controlsWrapper.style.minWidth = '50px';
  controlsWrapper.style.borderRadius = '50px';
  controlButtons.style.transform = 'translateX(-20px)';
  controlButtons.style.opacity = '0';
  controlButtons.style.pointerEvents = 'none';
});
</script>

<!-- éšè—åº¦è°ƒèŠ‚è„šæœ¬ -->
<script>
function initTransparencyControl() {
  console.log('Initializing transparency control');
  var transparencyToggle = document.getElementById('transparency-toggle');
  var transparencyPanel = document.getElementById('transparency-panel');
  var transparencySlider = document.getElementById('transparency-slider');
  var transparencyValue = document.getElementById('transparency-value');
  
  console.log('Transparency control elements:', {
    toggle: !!transparencyToggle,
    panel: !!transparencyPanel,
    slider: !!transparencySlider,
    value: !!transparencyValue
  });
  
  // ä¸‰ä¸ªåŒºå—å…ƒç´ 
  var mainContent = document.querySelector('.main');
  var sidebarLeft = document.querySelector('.sidebar.left-sidebar');
  var sidebarRight = document.querySelector('.sidebar.right-sidebar');
  
  console.log('Content elements:', {
    main: !!mainContent,
    left: !!sidebarLeft,
    right: !!sidebarRight
  });
  
  // åˆå§‹é€æ˜åº¦è®¾ç½®ï¼ˆå®Œå…¨ä¸é€æ˜ï¼Œé»˜è®¤çŠ¶æ€ï¼‰
  var initialOpacity = 1.0;
  
  // åº”ç”¨é€æ˜åº¦
  function applyOpacity(opacity) {
    console.log('Applying opacity:', opacity);
    if (mainContent) {
      mainContent.style.opacity = opacity;
      console.log('Applied opacity to main content:', opacity);
    }
    if (sidebarLeft) {
      sidebarLeft.style.opacity = '1'; // å·¦ä¾§ä¾§è¾¹æ å§‹ç»ˆæ˜¾ç¤º
      console.log('Applied opacity to left sidebar:', 1);
    }
    if (sidebarRight) {
      sidebarRight.style.opacity = opacity;
      console.log('Applied opacity to right sidebar:', opacity);
      // ç¡®ä¿å³ä¾§ä¾§è¾¹æ å†…çš„æ‰€æœ‰å†…å®¹ä¹Ÿè¢«éšè—
      var sidebarRightContents = sidebarRight.querySelectorAll('*');
      for (var i = 0; i < sidebarRightContents.length; i++) {
        sidebarRightContents[i].style.opacity = opacity;
      }
    }
  }
  
  // åˆå§‹åº”ç”¨é»˜è®¤é€æ˜åº¦
  applyOpacity(initialOpacity);
  
  // éšè—åº¦è°ƒèŠ‚æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  if (transparencyToggle) {
    console.log('Adding click event listener to transparency toggle');
    var isPanelVisible = false;
    transparencyToggle.onclick = function() {
      console.log('Transparency toggle clicked');
      isPanelVisible = !isPanelVisible;
      
      console.log('Current panel visibility:', isPanelVisible);
      
      if (isPanelVisible) {
        // æ˜¾ç¤ºé¢æ¿
        console.log('Showing transparency panel');
        transparencyPanel.style.transform = 'translateX(0%)';
        transparencyPanel.style.opacity = '1';
        transparencyPanel.style.pointerEvents = 'auto';
      } else {
        // éšè—é¢æ¿
        console.log('Hiding transparency panel');
        transparencyPanel.style.transform = 'translateX(100%)';
        transparencyPanel.style.opacity = '0';
        transparencyPanel.style.pointerEvents = 'none';
      }
    };
  }
  
  // æ»‘å—å˜åŒ–äº‹ä»¶
  if (transparencySlider) {
    console.log('Adding input event listener to transparency slider');
    transparencySlider.oninput = function() {
      var value = parseInt(this.value);
      var opacity = value / 100;
      
      console.log('Slider value changed:', value, 'Opacity:', opacity);
      
      // åº”ç”¨é€æ˜åº¦
      applyOpacity(opacity);
      
      // æ›´æ–°æ˜¾ç¤ºå€¼
      if (transparencyValue) {
        transparencyValue.textContent = value + '%';
        console.log('Updated transparency value:', value + '%');
      }
    };
  }
  
  // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­é¢æ¿
  console.log('Adding click event listener to document for panel closing');
  document.addEventListener('click', function(event) {
    if (transparencyPanel && transparencyToggle && !transparencyPanel.contains(event.target) && !transparencyToggle.contains(event.target)) {
      console.log('Click outside transparency panel, hiding panel');
      transparencyPanel.style.transform = 'translateX(100%)';
      transparencyPanel.style.opacity = '0';
      transparencyPanel.style.pointerEvents = 'none';
    }
  });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.onload = function() {
  initTransparencyControl();
  initImmersiveReading();
  initMouseBottomDetection();
  initPjaxEvents();
};

// åˆå§‹åŒ–æ²‰æµ¸é˜…è¯»åŠŸèƒ½
function initImmersiveReading() {
  var immersiveButton = document.getElementById('immersive-reading-button');
  var body = document.body;
  var mainContent = document.querySelector('.main');
  var sidebarLeft = document.querySelector('.sidebar.left-sidebar');
  var sidebarRight = document.querySelector('.sidebar.right-sidebar');
  var musicPlayer = document.getElementById('global-music-player');
  var expandableContainer = document.querySelector('.expandable-controls-container');
  var container = document.querySelector('.container.main-container');
  
  // éšè—å³ä¾§è¾¹æ ï¼Œæ— è®ºæ˜¯å¦ä¸ºæ–‡ç« é¡µé¢
  if (sidebarRight) {
    sidebarRight.style.display = 'none';
  }
  
  // è°ƒæ•´å®¹å™¨å¸ƒå±€ï¼Œç¡®ä¿ä¸»å†…å®¹åŒºåŸŸåœ¨å·¦ä¾§è¾¹æ çš„å³è¾¹æ˜¾ç¤º
  if (container) {
    container.classList.remove('extended');
    container.classList.add('compact');
  }
  
  // é‡ç½®ä¸»å†…å®¹åŒºåŸŸçš„æ ·å¼ï¼Œè®©å…¶æŒ‰ç…§é»˜è®¤å¸ƒå±€æ˜¾ç¤º
  if (mainContent) {
    mainContent.style.width = '';
    mainContent.style.maxWidth = '';
    mainContent.style.margin = '';
    mainContent.style.padding = '';
    mainContent.style.borderRadius = '';
    mainContent.style.boxShadow = '';
    mainContent.style.background = '';
    mainContent.style.backdropFilter = '';
    mainContent.style.webkitBackdropFilter = '';
  }
  
  if (immersiveButton) {
    immersiveButton.onclick = function() {
      var isImmersive = body.classList.contains('immersive-reading');
      
      if (isImmersive) {
        // é€€å‡ºæ²‰æµ¸é˜…è¯»æ¨¡å¼
        body.classList.remove('immersive-reading');
        immersiveButton.classList.remove('active');
        immersiveButton.setAttribute('aria-label', 'æ²‰æµ¸é˜…è¯»');
        immersiveButton.setAttribute('title', 'æ²‰æµ¸é˜…è¯»');
        
        // æ˜¾ç¤ºå·¦ä¾§è¾¹æ 
        if (sidebarLeft) {
          sidebarLeft.style.display = '';
        }
        
        // ä¿æŒå³ä¾§è¾¹æ éšè—
        if (sidebarRight) {
          sidebarRight.style.display = 'none';
        }
        
        if (musicPlayer) {
          musicPlayer.style.display = '';
        }
        if (expandableContainer) {
          expandableContainer.style.display = '';
        }
        
        // é‡ç½®ä¸»å†…å®¹åŒºåŸŸçš„æ ·å¼
        if (mainContent) {
          mainContent.style.width = '';
          mainContent.style.maxWidth = '';
          mainContent.style.margin = '';
          mainContent.style.padding = '';
          mainContent.style.borderRadius = '';
          mainContent.style.boxShadow = '';
          mainContent.style.background = '';
          mainContent.style.backdropFilter = '';
          mainContent.style.webkitBackdropFilter = '';
        }
        
        // è°ƒæ•´å®¹å™¨å¸ƒå±€
        if (container) {
          container.classList.remove('extended');
          container.classList.add('compact');
          container.style.display = '';
          container.style.maxWidth = '';
          container.style.padding = '';
        }
        
        // åˆ‡æ¢å›¾æ ‡
        var bookIcon = immersiveButton.querySelector('.book-icon');
        var exitIcon = immersiveButton.querySelector('.exit-icon');
        if (bookIcon) bookIcon.style.display = 'block';
        if (exitIcon) exitIcon.style.display = 'none';
      } else {
        // è¿›å…¥æ²‰æµ¸é˜…è¯»æ¨¡å¼
        body.classList.add('immersive-reading');
        immersiveButton.classList.add('active');
        immersiveButton.setAttribute('aria-label', 'é€€å‡ºæ²‰æµ¸é˜…è¯»');
        immersiveButton.setAttribute('title', 'é€€å‡ºæ²‰æµ¸é˜…è¯»');
        
        // éšè—å·¦ä¾§è¾¹æ 
        if (sidebarLeft) {
          sidebarLeft.style.display = 'none';
        }
        
        // ä¿æŒå³ä¾§è¾¹æ éšè—
        if (sidebarRight) {
          sidebarRight.style.display = 'none';
        }
        
        // éšè—éŸ³ä¹æ’­æ”¾å™¨
        if (musicPlayer) {
          musicPlayer.style.display = 'none';
        }
        
        // ä¿ç•™å³ä¸‹è§’æŒ‰é’®é¢æ¿
        if (expandableContainer) {
          expandableContainer.style.display = '';
        }
        
        // è°ƒæ•´ä¸»å†…å®¹åŒºåŸŸï¼Œä½¿å…¶å æ®æ‰€æœ‰ä¸‰ä¸ªåŒºåŸŸ
        if (mainContent) {
          mainContent.style.width = '100%';
          mainContent.style.maxWidth = '100%';
          mainContent.style.margin = '0';
          mainContent.style.padding = '40px';
          mainContent.style.borderRadius = '0';
          mainContent.style.boxShadow = 'none';
          mainContent.style.background = 'transparent';
          mainContent.style.backdropFilter = 'none';
          mainContent.style.webkitBackdropFilter = 'none';
        }
        
        // è°ƒæ•´å®¹å™¨å¸ƒå±€
        if (container) {
          container.style.display = 'block';
          container.style.maxWidth = '100%';
          container.style.padding = '0';
          container.style.width = '100%';
        }
        
        // è°ƒæ•´æ–‡ç« å†…å®¹åŒºåŸŸï¼Œä½¿å…¶å æ®æ‰€æœ‰å¯ç”¨ç©ºé—´
        var articleContent = document.querySelector('article');
        if (articleContent) {
          articleContent.style.maxWidth = '100%';
          articleContent.style.width = '100%';
        }
        
        // è°ƒæ•´æ–‡ç« å®¹å™¨ï¼Œä½¿å…¶å æ®æ‰€æœ‰å¯ç”¨ç©ºé—´
        var mainArticle = document.querySelector('.main-article');
        if (mainArticle) {
          mainArticle.style.maxWidth = '100%';
          mainArticle.style.width = '100%';
        }
        
        // åˆ‡æ¢å›¾æ ‡
        var bookIcon = immersiveButton.querySelector('.book-icon');
        var exitIcon = immersiveButton.querySelector('.exit-icon');
        if (bookIcon) bookIcon.style.display = 'none';
        if (exitIcon) exitIcon.style.display = 'block';
      }
    };
  }
}

// åˆå§‹åŒ–é¼ æ ‡åº•éƒ¨æ£€æµ‹åŠŸèƒ½ - å·²ä¿®æ”¹ï¼šç§»é™¤è‡ªåŠ¨æ˜¾ç¤º/éšè—æ’­æ”¾å™¨çš„åŠŸèƒ½ï¼Œç”±éŸ³ä¹æŒ‰é’®æ§åˆ¶
function initMouseBottomDetection() {
  // æ­¤å‡½æ•°ä¿ç•™ç”¨äºå…¶ä»–å¯èƒ½çš„åº•éƒ¨æ£€æµ‹åŠŸèƒ½
  // æ’­æ”¾å™¨çš„æ˜¾ç¤º/éšè—ç°åœ¨åªç”±éŸ³ä¹æŒ‰é’®æ§åˆ¶
}

// åˆå§‹åŒ–PJAXäº‹ä»¶ç›‘å¬
function initPjaxEvents() {
  // ç›‘å¬PJAXå¼€å§‹äº‹ä»¶
  document.addEventListener('pjax:send', function() {
    console.log('PJAX send event');
    // ä¿å­˜æ’­æ”¾å™¨çŠ¶æ€
    if (typeof savePlayerState === 'function') {
      savePlayerState();
    }
  });
  
  // ç›‘å¬PJAXæˆåŠŸäº‹ä»¶
  document.addEventListener('pjax:success', function() {
    console.log('PJAX success event');
    // é‡æ–°åˆå§‹åŒ–é¼ æ ‡åº•éƒ¨æ£€æµ‹åŠŸèƒ½
    initMouseBottomDetection();
    // é‡æ–°åˆå§‹åŒ–æ²‰æµ¸é˜…è¯»åŠŸèƒ½
    initImmersiveReading();
  });
  
  // ç›‘å¬PJAXå®Œæˆäº‹ä»¶
  document.addEventListener('pjax:complete', function() {
    console.log('PJAX complete event');
    // é‡æ–°åˆå§‹åŒ–æ’­æ”¾å™¨UI
    if (typeof reinitPlayerUI === 'function') {
      reinitPlayerUI();
    }
    // æ¢å¤æ’­æ”¾çŠ¶æ€
    if (typeof audio !== 'undefined' && audio && typeof playerState !== 'undefined' && playerState.isPlaying && audio.paused) {
      audio.play().catch(error => {
        console.warn('Resume play on PJAX complete failed:', error);
      });
    }
  });
}


</script>